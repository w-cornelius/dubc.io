<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Glossary Flashcards with Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .card-front {
            background-color: #fff;
            color: #1f2937;
        }
        .card-back {
            background-color: #f3f4f6;
            color: #1f2937;
            transform: rotateY(180deg);
            overflow-y: auto;
        }
        .card-back::-webkit-scrollbar {
            width: 8px;
        }
        .card-back::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .card-back::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .card-back::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        #geminiResponse {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-2">Real Estate Flashcards</h1>
        <p class="text-gray-600 text-center mb-6">Click the card for the definition, or ask Gemini for more info.</p>

        <!-- Flashcard Section -->
        <div class="flashcard-container w-full h-80 md:h-96 mb-6">
            <div id="flashcard" class="flashcard cursor-pointer">
                <div class="card-face card-front">
                    <h2 id="term" class="text-2xl md:text-3xl font-semibold"></h2>
                </div>
                <div class="card-face card-back">
                    <p id="definition" class="text-base md:text-lg"></p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex items-center justify-between w-full">
            <button id="prevBtn" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <div id="cardCounter" class="text-lg font-medium text-gray-700"></div>
            <button id="nextBtn" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 justify-center mt-4">
            <button id="shuffleBtn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Shuffle
            </button>
            <button id="flipContentBtn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-colors">
                Flip
            </button>
            <button id="hideCardBtn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
                Hide Card
            </button>
            <button id="resetBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                Reset All
            </button>
        </div>

        <!-- Gemini AI Section -->
        <div class="mt-8 pt-6 border-t border-gray-300">
            <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Ask Gemini</h3>
            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="userQuestion" placeholder="Ask a question about this term..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <button id="askGeminiBtn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                    Ask
                </button>
            </div>
            <div id="geminiResponseContainer" class="bg-white p-4 rounded-lg shadow-inner min-h-[100px]">
                <div id="geminiLoader" class="hidden text-center text-gray-500">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-2"></div>
                    Thinking...
                </div>
                <p id="geminiResponse" class="text-gray-700"></p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const allFlashcardData = [
            { term: '1031 tax-deferred exchange', definition: 'Section 1031 of the Internal Revenue Code allows the owner of real property to sell that property and then reinvest in a "like-kind" property and defer paying any capital gains taxes; strict IRS rules regulate this type of exchange' },
            { term: '15-year loan', definition: 'A nontraditional mortgage product that shortens the standard mortgage term from 30 years to 15 years' },
            { term: 'abutting', definition: 'Land parcels that share a common border' },
            { term: 'acceleration clause', definition: 'Allows a lender to demand immediate and full payment of all debt owed if a buyer defaults or fails to meet certain conditions that apply to the loan' },
            { term: 'accession', definition: 'The addition of value to property through labor or the addition of new materials, including an increase in land through natural processes' }
        ];

        // --- STATE MANAGEMENT ---
        let currentCardIndex = 0;
        let activeCards = [];
        let studiedCardIndices = new Set();
        let isTermFirst = true;

        // --- DOM ELEMENTS ---
        const flashcard = document.getElementById('flashcard');
        const termEl = document.getElementById('term');
        const definitionEl = document.getElementById('definition');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const flipContentBtn = document.getElementById('flipContentBtn');
        const hideCardBtn = document.getElementById('hideCardBtn');
        const resetBtn = document.getElementById('resetBtn');
        const cardCounterEl = document.getElementById('cardCounter');
        const askGeminiBtn = document.getElementById('askGeminiBtn');
        const userQuestionInput = document.getElementById('userQuestion');
        const geminiResponseEl = document.getElementById('geminiResponse');
        const geminiLoader = document.getElementById('geminiLoader');

        // --- FUNCTIONS ---

        function loadState() {
            const savedStudied = localStorage.getItem('studiedRealEstateCards');
            if (savedStudied) {
                studiedCardIndices = new Set(JSON.parse(savedStudied));
            }
            const savedFlipState = localStorage.getItem('isTermFirst');
            if (savedFlipState !== null) {
                isTermFirst = JSON.parse(savedFlipState);
            }
        }

        function saveState() {
            localStorage.setItem('studiedRealEstateCards', JSON.stringify(Array.from(studiedCardIndices)));
            localStorage.setItem('isTermFirst', JSON.stringify(isTermFirst));
        }
        
        function initializeDeck() {
            activeCards = allFlashcardData.filter((_, index) => !studiedCardIndices.has(index));
            if (activeCards.length === 0 && allFlashcardData.length > 0) {
                resetDeck();
                return;
            }
            currentCardIndex = 0;
            displayCard();
        }

        function displayCard() {
            if (activeCards.length === 0) {
                termEl.textContent = "All cards studied!";
                definitionEl.textContent = "Click 'Reset & Unhide All' to start over.";
                cardCounterEl.textContent = `${allFlashcardData.length} / ${allFlashcardData.length}`;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                hideCardBtn.disabled = true;
                return;
            }

            hideCardBtn.disabled = false;
            const cardData = activeCards[currentCardIndex];
            
            if (isTermFirst) {
                termEl.textContent = cardData.term;
                definitionEl.textContent = cardData.definition;
            } else {
                termEl.textContent = cardData.definition;
                definitionEl.textContent = cardData.term;
            }
            
            updateCounter();
            updateNavButtons();
            if (flashcard.classList.contains('is-flipped')) {
                flashcard.classList.remove('is-flipped');
            }
            userQuestionInput.value = '';
            geminiResponseEl.textContent = '';
        }

        function updateCounter() {
            const studiedCount = studiedCardIndices.size;
            const totalCount = allFlashcardData.length;
            const currentPositionInDeck = activeCards.length > 0 ? currentCardIndex + 1 : 0;
            const activeCount = activeCards.length;
            cardCounterEl.textContent = `${currentPositionInDeck} / ${activeCount} (Studied: ${studiedCount})`;
        }

        function updateNavButtons() {
            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.disabled = currentCardIndex >= activeCards.length - 1;
        }

        function flipCard() {
            if (activeCards.length > 0) {
                flashcard.classList.toggle('is-flipped');
            }
        }

        function showNextCard() {
            if (currentCardIndex < activeCards.length - 1) {
                currentCardIndex++;
                displayCard();
            }
        }
        
        function showPrevCard() {
             if (currentCardIndex > 0) {
                currentCardIndex--;
                displayCard();
            }
        }

        function hideCurrentCard() {
            if (activeCards.length === 0) return;
            const cardToFind = activeCards[currentCardIndex];
            const originalIndex = allFlashcardData.findIndex(card => card.term === cardToFind.term && card.definition === cardToFind.definition);
            
            if (originalIndex !== -1) {
                studiedCardIndices.add(originalIndex);
                activeCards.splice(currentCardIndex, 1);
                saveState();

                if (currentCardIndex >= activeCards.length && activeCards.length > 0) {
                    currentCardIndex = activeCards.length - 1;
                }
                displayCard();
            }
        }

        function shuffleCards() {
            for (let i = activeCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [activeCards[i], activeCards[j]] = [activeCards[j], activeCards[i]];
            }
            currentCardIndex = 0;
            displayCard();
        }

        function flipCardContent() {
            isTermFirst = !isTermFirst;
            saveState();
            displayCard();
        }

        function resetDeck() {
            studiedCardIndices.clear();
            saveState();
            initializeDeck();
        }

        // --- Gemini API Call via Secure Worker ---
        async function callGemini(prompt) {
            const apiUrl = 'https://dubbc-ai-proxy.wcornelius.workers.dev/';
            // Corrected payload to send a simple object with a 'prompt' key
            const payload = { prompt: prompt };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
                }
                // The worker should return the Gemini response structure directly
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else {
                    console.error('Unexpected API response format:', result);
                    throw new Error('Unexpected API response format');
                }
            } catch (error) {
                console.error('Error calling the proxy worker:', error);
                return `An error occurred: ${error.message}. Please try again later.`;
            }
        }

        async function handleAskGemini() {
            const userQuestion = userQuestionInput.value;
            if (!userQuestion.trim()) {
                geminiResponseEl.textContent = "Please enter a question.";
                return;
            }
            if (activeCards.length === 0) {
                geminiResponseEl.textContent = "Please reset the deck to select a term.";
                return;
            }

            geminiLoader.classList.remove('hidden');
            geminiResponseEl.textContent = '';
            askGeminiBtn.disabled = true;

            const currentCard = activeCards[currentCardIndex];
            const prompt = `You are a helpful real estate expert. In the context of the real estate term "${currentCard.term}", which is defined as "${currentCard.definition}", please answer the following question clearly and concisely: "${userQuestion}"`;
            
            const responseText = await callGemini(prompt);
            geminiResponseEl.textContent = responseText;
            
            geminiLoader.classList.add('hidden');
            askGeminiBtn.disabled = false;
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        flashcard.addEventListener('click', flipCard);
        nextBtn.addEventListener('click', showNextCard);
        prevBtn.addEventListener('click', showPrevCard);
        shuffleBtn.addEventListener('click', shuffleCards);
        flipContentBtn.addEventListener('click', flipCardContent);
        hideCardBtn.addEventListener('click', hideCurrentCard);
        resetBtn.addEventListener('click', resetDeck);
        askGeminiBtn.addEventListener('click', handleAskGemini);
        userQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleAskGemini();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (document.activeElement === userQuestionInput) return;
            if (e.key === 'ArrowRight') nextBtn.click();
            if (e.key === 'ArrowLeft') prevBtn.click();
            if (e.key === ' ') {
                e.preventDefault();
                flipCard();
            }
        });
        
        // Initial Load
        loadState();
        initializeDeck();

    </script>
</body>
</html>
